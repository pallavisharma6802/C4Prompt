<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Green AI ‚Äî Carbon-Aware Conversations</title>
    <style>
      :root{
        --eco-green: #10b981;
        --eco-light: #d1fae5;
        --eco-dark: #047857;
        --warning-yellow: #f59e0b;
        --danger-red: #ef4444;
        --danger-dark: #991b1b;
        --bg-clean: #f0fdf4;
        --bg-white: #ffffff;
        --card-clean: rgba(255,255,255,0.95);
        --text-dark: #064e3b;
        --text-muted: #6b7280;
        --shadow-soft: rgba(16,185,129,0.15);
        --shadow-warn: rgba(245,158,11,0.2);
        --shadow-danger: rgba(239,68,68,0.25);
      }
      html,body{height:100%; margin:0; overflow-x:hidden;}
      body{
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        background: linear-gradient(135deg, #ecfdf5, #d1fae5);
        color: var(--text-dark);
        -webkit-font-smoothing:antialiased;
        transition: background 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
      }
      body.warning-state{
        background: linear-gradient(135deg, #fef3c7, #fed7aa);
      }
      body.danger-state{
        background: linear-gradient(135deg, #fee2e2, #fecaca);
      }
      .bg-overlay{
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
        opacity: 0;
        transition: opacity 1s ease;
      }
      .bg-overlay.active{
        opacity: 1;
      }
      .app{ 
        width:100%; 
        max-width:1200px; 
        margin: 0 auto;
        padding: 40px 32px;
        position: relative;
        z-index: 1;
      }
      .header{ 
        display:flex; 
        align-items:center; 
        gap:20px; 
        margin-bottom:32px;
        background: var(--card-clean);
        padding: 24px 28px;
        border-radius: 20px;
        box-shadow: 0 4px 20px var(--shadow-soft);
        border: 2px solid rgba(16,185,129,0.2);
      }
      .logo{ 
        width:64px; 
        height:64px; 
        border-radius:16px; 
        background: linear-gradient(135deg, var(--eco-green), var(--eco-dark)); 
        display:flex; 
        align-items:center; 
        justify-content:center; 
        box-shadow:0 8px 24px var(--shadow-soft);
        flex-shrink: 0;
      }
      .logo svg{ width:38px; height:38px; }
      .logo:hover{ transform:translateY(-4px) rotate(5deg); transition:transform .32s cubic-bezier(.2,.8,.2,1); }
      .logo{ transition:transform .4s cubic-bezier(.2,.8,.2,1); }
      h1{ 
        font-size:28px; 
        margin:0;
        font-weight: 800;
        background: linear-gradient(90deg, var(--eco-dark), var(--eco-green));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      p.lead{ 
        margin:6px 0 0 0; 
        color:var(--text-muted); 
        font-size:14px;
        line-height: 1.5;
      }

      .grid{ display:grid; grid-template-columns: 1fr 440px; gap:24px; align-items:start; }

      .card{ 
        background: var(--card-clean); 
        border-radius:16px; 
        padding:24px; 
        box-shadow: 0 4px 20px var(--shadow-soft);
        border: 1px solid rgba(16,185,129,0.15);
      }

      .card-title{
        font-size: 18px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      textarea#prompt{ 
        width:100%; 
        height:200px; 
        resize:vertical; 
        padding:16px; 
        border-radius:12px; 
        border:2px solid rgba(16,185,129,0.2); 
        background: rgba(255,255,255,0.6);
        color: var(--text-dark); 
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; 
        font-size:14px;
        transition: all 0.3s ease;
        line-height: 1.6;
      }
      textarea#prompt:focus{
        outline: none;
        border-color: var(--eco-green);
        background: rgba(255,255,255,0.9);
        box-shadow: 0 0 0 3px rgba(16,185,129,0.1);
      }
      textarea#prompt.warning{
        border-color: var(--warning-yellow);
        background: rgba(254,243,199,0.3);
      }
      textarea#prompt.danger{
        border-color: var(--danger-red);
        background: rgba(254,226,226,0.3);
      }

      .carbon-meter{
        height: 8px;
        background: linear-gradient(90deg, var(--eco-green) 0%, var(--warning-yellow) 50%, var(--danger-red) 100%);
        border-radius: 20px;
        margin: 12px 0;
        position: relative;
        overflow: hidden;
      }
      .carbon-indicator{
        position: absolute;
        top: -8px;
        width: 4px;
        height: 24px;
        background: var(--text-dark);
        border-radius: 2px;
        transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      }
      .carbon-label{
        font-size: 12px;
        color: var(--text-muted);
        text-align: center;
        margin-top: 8px;
      }

      .controls{ 
        display:flex; 
        gap:10px; 
        align-items:center; 
        margin-top:16px;
        flex-wrap: wrap;
      }
      .btn{ 
        background: linear-gradient(135deg, var(--eco-green), var(--eco-dark)); 
        color: white; 
        border:none; 
        padding:12px 20px; 
        border-radius:12px; 
        font-weight:600; 
        cursor:pointer; 
        box-shadow:0 4px 12px var(--shadow-soft); 
        transform:translateY(0); 
        transition:all .2s ease;
        font-size: 14px;
      }
      .btn:hover{ 
        transform:translateY(-2px); 
        box-shadow:0 6px 20px var(--shadow-soft);
      }
      .btn:active{ 
        transform:translateY(0) scale(.98); 
      }
      .btn.ghost{ 
        background: transparent; 
        border:2px solid var(--eco-green); 
        color: var(--eco-dark); 
        box-shadow: none;
      }
      .btn.ghost:hover{
        background: rgba(16,185,129,0.1);
      }
      .muted{ 
        color:var(--text-muted); 
        font-size:13px;
      }

      label.checkbox-label{
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--text-muted);
        font-size: 13px;
        cursor: pointer;
        user-select: none;
      }
      label.checkbox-label input[type="checkbox"]{
        accent-color: var(--eco-green);
        cursor: pointer;
      }

      .result{ 
        white-space:pre-wrap; 
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; 
        font-size:14px; 
        padding:16px; 
        border-radius:12px; 
        background: rgba(255,255,255,0.6);
        border:2px solid rgba(16,185,129,0.2);
        line-height: 1.6;
        min-height: 120px;
      }

      .ref{ 
        color: var(--eco-dark); 
        background: var(--eco-light); 
        padding:2px 8px; 
        border-radius:8px; 
        margin:0 2px; 
        cursor:pointer; 
        font-weight:600; 
        transition:all .18s ease;
        border: 1px solid var(--eco-green);
      }
      .ref:hover{ 
        transform:translateY(-2px); 
        box-shadow:0 4px 12px var(--shadow-soft);
        background: var(--eco-green);
        color: white;
      }
      .ref-value{ 
        color: white; 
        background: var(--eco-green); 
        padding:6px 12px; 
        border-radius:10px; 
        margin-left:8px; 
        font-weight:600; 
        display:inline-block; 
        transform:translateY(-6px) scale(.95); 
        opacity:0; 
        transition:transform .25s cubic-bezier(.2,.8,.2,1),opacity .25s cubic-bezier(.2,.8,.2,1);
        box-shadow: 0 4px 12px var(--shadow-soft);
      }
      .ref-value.show{ transform:none; opacity:1 }
      .ref-value.hide{ transform:translateY(-6px) scale(.95); opacity:0 }
      
      .badge{ 
        background: var(--eco-light); 
        color: var(--eco-dark); 
        padding:8px 14px; 
        border-radius:999px; 
        font-weight:700; 
        display:inline-flex; 
        gap:10px; 
        align-items:center;
        border: 2px solid var(--eco-green);
      }
      .badge .delta{ 
        color: var(--eco-dark); 
        font-weight:800; 
      }
      .pulse{ 
        animation:pop .45s cubic-bezier(.2,.8,.2,1); 
      }
      @keyframes pop{ 
        0%{ transform:scale(.88); opacity:.7 } 
        60%{ transform:scale(1.08); opacity:1 } 
        100%{ transform:scale(1); opacity:1 } 
      }

      .panel{ display:flex; flex-direction:column; gap:16px }
      .stats{ display:flex; gap:12px; flex-wrap:wrap }
      .stat{ 
        background: var(--eco-light); 
        padding:12px 16px; 
        border-radius:12px; 
        color: var(--text-dark); 
        min-width:140px;
        border: 1px solid var(--eco-green);
        font-size: 13px;
      }
      .stat strong{
        display: block;
        font-size: 20px;
        font-weight: 800;
        color: var(--eco-dark);
        margin-top: 4px;
      }

      .impact-card{
        background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.05));
        border: 2px solid var(--eco-green);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
      }
      .impact-title{
        font-size: 16px;
        font-weight: 700;
        color: var(--eco-dark);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .impact-metrics{
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }
      .impact-metric{
        text-align: center;
        padding: 12px;
        background: white;
        border-radius: 10px;
        border: 1px solid rgba(16,185,129,0.3);
      }
      .impact-metric-value{
        font-size: 24px;
        font-weight: 800;
        color: var(--eco-dark);
      }
      .impact-metric-label{
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .replacements{ 
        max-height:300px; 
        overflow:auto; 
        padding:12px; 
        border-radius:12px; 
        background: rgba(255,255,255,0.6);
        border:2px solid rgba(16,185,129,0.2);
      }

      footer{ 
        margin-top:16px; 
        color:var(--text-muted); 
        font-size:13px;
        line-height: 1.5;
      }

      @media (max-width:980px){ 
        .grid{ grid-template-columns: 1fr; }
        .app{ padding: 24px 16px; }
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(16,185,129,0.1);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--eco-green);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--eco-dark);
      }
    </style>
  </head>
  <body>
    <div class="bg-overlay" id="bgOverlay"></div>
    <div class="app">
      <div class="header">
        <div class="logo" aria-hidden>
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L3 7v6c0 5.5 3.8 10.7 9 12 5.2-1.3 9-6.5 9-12V7l-9-5z" fill="white" opacity="0.9"/>
            <path d="M9 12l2 2 4-4" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div style="flex: 1;">
          <h1>üåç Green AI ‚Äî Carbon-Aware Conversations</h1>
          <p class="lead">Reduce AI's carbon footprint by optimizing your prompts. Every token saved = less energy, fewer emissions, cleaner planet.</p>
        </div>
        <div style="display:flex; align-items:center; gap:12px">
          <div class="badge" title="Total tokens you've saved (stored locally)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 2v20M5 8h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <div>
              <div style="font-size:10px; text-transform: uppercase; letter-spacing: 0.5px;">Tokens Saved</div>
              <div id="totalSaved" style="font-size:18px; font-weight: 800;">0</div>
            </div>
          </div>
          <button id="resetTotal" class="btn ghost" style="padding:10px 14px">Reset</button>
        </div>
      </div>

      <div class="grid">
        <div>
          <!-- Carbon Impact Awareness Card -->
          <div class="impact-card">
            <div class="impact-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M12 2v20M17 7H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Real-Time Carbon Impact
            </div>
            <div class="impact-metrics">
              <div class="impact-metric">
                <div class="impact-metric-value" id="carbonSaved">0</div>
                <div class="impact-metric-label">gCO‚ÇÇe Saved</div>
              </div>
              <div class="impact-metric">
                <div class="impact-metric-value" id="energySaved">0</div>
                <div class="impact-metric-label">Wh Saved</div>
              </div>
              <div class="impact-metric">
                <div class="impact-metric-value" id="waterSaved">0</div>
                <div class="impact-metric-label">mL Water Saved</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">
              ‚úçÔ∏è Smart Prompting ‚Äî Feature #1
            </div>
            <label class="muted" style="display: block; margin-bottom: 8px;">Enter your prompt below and watch the carbon impact change</label>
            <textarea id="prompt" placeholder="Paste your AI prompt here...

Try something verbose like:
'Write a very detailed, comprehensive, and extremely thorough answer. Please make sure to include all relevant information and examples...'"></textarea>
            
            <div class="carbon-meter">
              <div class="carbon-indicator" id="carbonIndicator"></div>
            </div>
            <div class="carbon-label" id="carbonLabel">üå± Eco-Friendly Zone</div>

            <div class="controls">
              <button id="compressBtn" class="btn">üåç Compress & Save Carbon</button>
              <button id="copyBtn" class="btn ghost">Copy Result</button>
              <button id="expandAll" class="btn ghost">Expand all</button>
              <button id="collapseAll" class="btn ghost">Collapse all</button>
            </div>
            
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(16,185,129,0.2);">
              <details>
                <summary style="cursor: pointer; font-weight: 600; color: var(--eco-dark); margin-bottom: 12px;">‚öôÔ∏è Advanced Compression Options</summary>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 12px;">
                  <label class="checkbox-label"><input type="checkbox" id="tiktoken"> Use tiktoken</label>
                  <label class="checkbox-label"><input type="checkbox" id="aggressive"> Aggressive mode</label>
                  <label class="checkbox-label"><input type="checkbox" id="remove_stopwords"> Remove stopwords</label>
                  <label class="checkbox-label"><input type="checkbox" id="remove_punctuation"> Remove punctuation</label>
                  <label class="checkbox-label"><input type="checkbox" id="light_stemming"> Light stemming</label>
                  <label class="checkbox-label"><input type="checkbox" id="super_aggressive"> Super aggressive</label>
                  <label class="checkbox-label"><input type="checkbox" id="encode"> Encoding mode</label>
                </div>
              </details>
            </div>
          </div>

          <div style="height:16px"></div>

          <div class="card">
            <div class="card-title">‚ú® Compressed Result</div>
            <div class="muted" style="font-size:12px; margin-bottom: 12px;">Click reference tokens to see original phrases</div>
            <div id="result" class="result">Waiting for compression...</div>
            <footer id="stats" class="muted">Ready to compress your first prompt</footer>
          </div>
        </div>

        <div>
          <div class="card panel">
            <div class="card-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M9 12h6M12 9v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Reference Mappings
            </div>
            <div id="replacements" class="replacements muted">No replacements yet.</div>
          </div>

          <div style="height:16px"></div>

          <div class="card panel">
            <div class="card-title">üìä Optimization Stats</div>
            <div class="stats" id="statList">
              <div class="stat">
                <span style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Original</span>
                <strong id="origTokens">‚Äî</strong>
              </div>
              <div class="stat">
                <span style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Compressed</span>
                <strong id="compTokens">‚Äî</strong>
              </div>
              <div class="stat">
                <span style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Saved</span>
                <strong id="savedTokens" style="color: var(--eco-green);">‚Äî</strong>
              </div>
            </div>
          </div>

          <div style="height:16px"></div>

          <div class="card panel" style="background: linear-gradient(135deg, rgba(16,185,129,0.05), rgba(5,150,105,0.02));">
            <div class="card-title">üí° Did You Know?</div>
            <div class="muted" style="line-height: 1.6;">
              <p style="margin: 0 0 12px 0;"><strong>Per Gemini prompt:</strong></p>
              <ul style="margin: 0; padding-left: 20px;">
                <li>0.24 Wh energy used</li>
                <li>0.03 gCO‚ÇÇe emissions</li>
                <li>0.26 mL water consumed</li>
                <li>‚âà 9 seconds of TV watching</li>
              </ul>
              <p style="margin: 16px 0 0 0; font-size: 12px; color: var(--text-muted);">Source: <a href="https://cloud.google.com/blog/products/infrastructure/measuring-the-environmental-impact-of-ai-inference/" target="_blank" style="color: var(--eco-green);">Google Cloud Study (2025)</a></p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div style="max-width:1200px; margin:24px auto 0; position: relative; z-index: 1;">
      <div class="card panel" style="padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <div class="card-title" style="margin: 0;">üìú Compression History</div>
          <div style="display:flex; gap:8px; align-items:center">
            <div class="muted" style="font-size:13px">Local storage</div>
            <button id="clearHistory" class="btn ghost" style="padding:8px 12px">Clear</button>
          </div>
        </div>
        <div id="historyList" style="max-height:220px; overflow:auto; margin-top:16px; color:var(--text-muted);">
          <div style="padding:12px; text-align: center; color: var(--text-muted);">No history yet. Compress your first prompt to get started! üå±</div>
        </div>
      </div>
    </div>

    <script>
      // Carbon impact constants (per token, based on Google's 0.24 Wh per prompt with ~100 tokens avg)
      const ENERGY_PER_TOKEN_WH = 0.0024; // 0.24 Wh / 100 tokens
      const CO2_PER_TOKEN_G = 0.0003;     // 0.03 gCO2e / 100 tokens
      const WATER_PER_TOKEN_ML = 0.0026;  // 0.26 mL / 100 tokens

      // Escape HTML
      const escape = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

      // Calculate carbon impact zone based on token count
      function updateCarbonMeter(tokenCount) {
        const indicator = document.getElementById('carbonIndicator');
        const label = document.getElementById('carbonLabel');
        const textarea = document.getElementById('prompt');
        const body = document.body;
        
        // Thresholds: 0-100 eco, 100-250 warning, 250+ danger
        let percentage = 0;
        let zone = 'eco';
        let labelText = 'üå± Eco-Friendly Zone';
        
        if (tokenCount <= 100) {
          percentage = (tokenCount / 100) * 33;
          zone = 'eco';
          labelText = `üå± Eco-Friendly (${tokenCount} tokens)`;
          body.classList.remove('warning-state', 'danger-state');
          textarea.classList.remove('warning', 'danger');
        } else if (tokenCount <= 250) {
          percentage = 33 + ((tokenCount - 100) / 150) * 33;
          zone = 'warning';
          labelText = `‚ö†Ô∏è Moderate Impact (${tokenCount} tokens)`;
          body.classList.add('warning-state');
          body.classList.remove('danger-state');
          textarea.classList.add('warning');
          textarea.classList.remove('danger');
        } else {
          percentage = 66 + Math.min(((tokenCount - 250) / 250) * 34, 34);
          zone = 'danger';
          labelText = `üî¥ High Carbon Impact (${tokenCount} tokens)`;
          body.classList.add('danger-state');
          body.classList.remove('warning-state');
          textarea.classList.add('danger');
          textarea.classList.remove('warning');
        }
        
        indicator.style.left = `${Math.min(percentage, 100)}%`;
        label.textContent = labelText;
        label.style.color = zone === 'danger' ? 'var(--danger-red)' : zone === 'warning' ? 'var(--warning-yellow)' : 'var(--eco-green)';
      }

      // Count tokens (simple whitespace-based)
      function countTokensSimple(text) {
        return Math.max(0, text.trim().split(/\s+/).filter(t => t.length > 0).length);
      }

      // Update carbon impact display
      function updateCarbonImpact(tokensSaved) {
        const carbonSaved = (tokensSaved * CO2_PER_TOKEN_G).toFixed(3);
        const energySaved = (tokensSaved * ENERGY_PER_TOKEN_WH).toFixed(3);
        const waterSaved = (tokensSaved * WATER_PER_TOKEN_ML).toFixed(2);
        
        document.getElementById('carbonSaved').textContent = carbonSaved;
        document.getElementById('energySaved').textContent = energySaved;
        document.getElementById('waterSaved').textContent = waterSaved;
      }

      // Real-time carbon meter update on typing
      document.getElementById('prompt').addEventListener('input', (e) => {
        const text = e.target.value;
        const tokens = countTokensSimple(text);
        updateCarbonMeter(tokens);
      });

      function renderCompressedWithRefs(text) {
        let out = text.replace(/\[REF(\d+)\]/g, (m, id) => `<span class="ref" data-ref="REF${id}">[REF${id}]</span>`);
        try{
          if(currentReplacements && Object.keys(currentReplacements).length){
            const keys = Object.keys(currentReplacements).slice().sort((a,b)=>b.length - a.length);
            for(const k of keys){
              if(!k || k.startsWith('REF') || k.startsWith('ENC')) continue;
              const esc = k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
              const re = new RegExp('\\b' + esc + '\\b', 'g');
              out = out.replace(re, (m)=> `<span class="ref" data-ref="${encodeURIComponent(k)}">${escape(k)}</span>`);
            }
          }
        }catch(e){ /* ignore */ }
        return out;
      }

      function buildReplacementsPanel(replacements){
        const container = document.getElementById('replacements');
        container.innerHTML = '';
        if(!replacements || Object.keys(replacements).length===0){ 
          container.innerHTML = '<div style="padding: 12px; text-align: center;">No replacements yet.</div>'; 
          return;
        }
        const ul = document.createElement('ul'); 
        ul.style.margin='0'; 
        ul.style.paddingLeft='20px'; 
        ul.style.color='var(--text-dark)';
        for(const k of Object.keys(replacements)){
          const li = document.createElement('li');
          li.style.marginBottom='10px';
          li.innerHTML = `<strong style="color: var(--eco-dark);">${escape(k)}</strong>: <span style="color: var(--text-muted);">${escape(replacements[k])}</span>`;
          ul.appendChild(li);
        }
        container.appendChild(ul);
      }
      }

      function shouldCapitalizeBefore(el){
        // Determine whether the inserted phrase should be capitalized based on prior character context.
        // Look for previous text content before the element inside the same container.
        const prev = el.previousSibling;
        let lastChar = null;
        if(prev){
          if(prev.nodeType === Node.TEXT_NODE){
            const txt = prev.textContent || '';
            for(let i = txt.length - 1; i >= 0; --i){
              const ch = txt[i];
              if(!/\s/.test(ch)) { lastChar = ch; break }
            }
          } else if(prev.nodeType === Node.ELEMENT_NODE){
            const txt = prev.innerText || '';
            for(let i = txt.length - 1; i >= 0; --i){
              const ch = txt[i];
              if(!/\s/.test(ch)) { lastChar = ch; break }
            }
          }
        }
        // If there is no previous non-space char, or the previous char ends a sentence, capitalize.
        if(!lastChar) return true;
        if(/[.!?]/.test(lastChar)) return true;
        return false;
      }

      function applyCapitalizationIfNeeded(phrase, el){
        try{
          if(!phrase) return phrase;
          const cap = shouldCapitalizeBefore(el);
          if(!cap) return phrase;
          // Capitalize first letter of the first word (leave rest unchanged)
          return phrase.charAt(0).toUpperCase() + phrase.slice(1);
        }catch(e){ return phrase }
      }

      function wireRefClicks(){
        document.querySelectorAll('.ref').forEach(el=>{
          el.onclick = (e)=>{
            const raw = e.target && e.target.dataset ? e.target.dataset.ref : null;
            const key = raw ? decodeURIComponent(raw) : null;
            // check next element
            const next = e.target.nextElementSibling;
            if(next && next.classList && next.classList.contains('ref-value')){
              // toggle visibility with animation
              if(next.classList.contains('show')){
                next.classList.remove('show'); next.classList.add('hide');
                // remove after animation
                setTimeout(()=>{ try{ next.remove() }catch(_){} }, 240);
              } else {
                next.classList.remove('hide'); next.classList.add('show');
              }
              return;
            }
            // insert preview with capitalization-aware content
            let phrase = currentReplacements[key || raw];
            if(!phrase) return;
            const node = document.createElement('span');
            node.className='ref-value hide';
            node.textContent = applyCapitalizationIfNeeded(phrase, e.target);
            // insert then trigger show to animate
            e.target.parentNode.insertBefore(node, e.target.nextSibling);
            // ensure layout and then show
            requestAnimationFrame(()=>{ node.classList.remove('hide'); node.classList.add('show'); });
          }
        })
      }

      let currentReplacements = {};

      // initialize total saved from localStorage
      const TOTAL_KEY = 'green_ai_total_saved';
      function readTotal(){ return parseInt(localStorage.getItem(TOTAL_KEY) || '0', 10) }
      function writeTotal(v){ localStorage.setItem(TOTAL_KEY, String(v)) }
      function setTotalDom(v){ 
        const el = document.getElementById('totalSaved'); 
        el.textContent = v.toLocaleString(); 
        el.classList.add('pulse'); 
        setTimeout(()=>el.classList.remove('pulse'),450) 
      }
      setTotalDom(readTotal());

      document.getElementById('compressBtn').onclick = async ()=>{
        const prompt = document.getElementById('prompt').value;
        if(!prompt.trim()){ 
          alert('Please enter a prompt first!');
          return;
        }
        
        const use_tiktoken = document.getElementById('tiktoken').checked;
        const aggressive = document.getElementById('aggressive').checked;
        const remove_stopwords = document.getElementById('remove_stopwords').checked;
        const remove_punctuation = document.getElementById('remove_punctuation').checked;
        const light_stemming = document.getElementById('light_stemming').checked;
        const super_aggressive = document.getElementById('super_aggressive').checked;
        const encode = document.getElementById('encode').checked;
        
        const resp = await fetch('/compress',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            prompt, 
            use_tiktoken, 
            aggressive, 
            remove_stopwords, 
            remove_punctuation, 
            light_stemming, 
            super_aggressive,
            encode
          })
        });
        const data = await resp.json();
        currentReplacements = data.meta && data.meta.replacements ? data.meta.replacements : {};

        const escaped = escape(data.compressed_prompt);
        const rendered = renderCompressedWithRefs(escaped);
        document.getElementById('result').innerHTML = rendered;
        buildReplacementsPanel(currentReplacements);
        
        const meta = data.meta || {};
        const opts = meta.opts || {};
        const details = `Compression applied ‚Ä¢ Fillers removed: ${meta.removed_fillers || 0} ‚Ä¢ Stopwords: ${meta.removed_stopwords || 0} ‚Ä¢ Punctuation: ${meta.removed_punctuation_tokens || 0} ‚Ä¢ Stems: ${meta.removed_light_stems || 0}`;
        document.getElementById('stats').textContent = details;
        
        document.getElementById('origTokens').textContent = data.original_tokens;
        document.getElementById('compTokens').textContent = data.compressed_tokens;
        document.getElementById('savedTokens').textContent = data.tokens_saved;

        // Update carbon impact
        updateCarbonImpact(data.tokens_saved);

        // update cumulative total (localStorage) and animate change
        const prev = readTotal();
        const added = Number(data.tokens_saved) || 0;
        const next = Math.max(0, prev + added);
        writeTotal(next);
        animateNumber(document.getElementById('totalSaved'), prev, next, 500);

        // record this run in history (localStorage)
        const entry = {
          ts: new Date().toISOString(),
          original_tokens: Number(data.original_tokens) || 0,
          compressed_tokens: Number(data.compressed_tokens) || 0,
          tokens_saved: Number(data.tokens_saved) || 0,
          compressed_prompt: data.compressed_prompt || '',
          carbon_saved: (added * CO2_PER_TOKEN_G).toFixed(3)
        };
        addHistoryEntry(entry);

        wireRefClicks();
      }

      function animateNumber(el, from, to, duration){
        const start = performance.now();
        const diff = to - from;
        function step(ts){
          const t = Math.min(1, (ts - start) / duration);
          const eased = t < 0.5 ? 2*t*t : -1 + (4 - 2*t)*t; // easeInOut-ish
          const val = Math.round(from + diff * eased);
          el.textContent = val.toLocaleString();
          if(t < 1) requestAnimationFrame(step);
          else { el.classList.add('pulse'); setTimeout(()=>el.classList.remove('pulse'),420) }
        }
        requestAnimationFrame(step);
      }

      // History helpers (localStorage)
      const HISTORY_KEY = 'green_ai_history';
      function readHistory(){
        try{ return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]') }catch(e){ return [] }
      }
      function writeHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0,200))) }
      function renderHistory(){
        const list = document.getElementById('historyList');
        const arr = readHistory();
        list.innerHTML = '';
        if(!arr || arr.length===0){ 
          list.innerHTML = '<div style="padding:12px; text-align: center; color: var(--text-muted);">No history yet. Compress your first prompt to get started! üå±</div>'; 
          return;
        }
        // recent first
        for(const e of arr.slice().reverse()){
          const row = document.createElement('div');
          row.style.padding = '12px'; 
          row.style.borderBottom = '1px solid rgba(16,185,129,0.1)'; 
          row.style.cursor='pointer';
          row.style.borderRadius = '8px';
          row.style.transition = 'background 0.2s ease';
          row.onmouseenter = () => row.style.background = 'rgba(16,185,129,0.05)';
          row.onmouseleave = () => row.style.background = 'transparent';
          row.title = (new Date(e.ts)).toLocaleString();
          const carbonInfo = e.carbon_saved ? ` ‚Ä¢ ${e.carbon_saved}g CO‚ÇÇ saved` : '';
          row.innerHTML = `<div style="display:flex;justify-content:space-between;gap:12px; margin-bottom: 6px;"><div style="font-size:12px; color: var(--text-muted);">${new Date(e.ts).toLocaleString()}</div><div style="font-weight:800; color:var(--eco-green);">+${e.tokens_saved} tokens</div></div><div style="font-size:12px; color:var(--text-muted);">Orig ${e.original_tokens} ‚Üí Comp ${e.compressed_tokens}${carbonInfo}</div>`;
          row.onclick = ()=>{
            document.getElementById('result').innerText = e.compressed_prompt;
            document.getElementById('origTokens').textContent = e.original_tokens;
            document.getElementById('compTokens').textContent = e.compressed_tokens;
            document.getElementById('savedTokens').textContent = e.tokens_saved;
            if(e.carbon_saved) {
              updateCarbonImpact(e.tokens_saved);
            }
            const el = document.getElementById('result'); 
            el.classList.add('pulse'); 
            setTimeout(()=>el.classList.remove('pulse'),450);
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };
          list.appendChild(row);
        }
      }

      function addHistoryEntry(entry){
        const arr = readHistory();
        arr.push(entry);
        // keep last 200 entries to avoid unlimited growth
        writeHistory(arr.slice(-200));
        renderHistory();
      }

      document.getElementById('clearHistory').onclick = ()=>{
        if(!confirm('Clear local history of compress runs?')) return;
        writeHistory([]);
        renderHistory();
      }

      // render existing history on load
      renderHistory();

      document.getElementById('expandAll').onclick = ()=>{
        // Click each ref to open (if already open it will toggle, so only open closed ones)
        document.querySelectorAll('.ref').forEach(r=>{
          const next = r.nextElementSibling;
          if(!(next && next.classList && next.classList.contains('ref-value'))){ r.click(); }
          else if(next && next.classList && next.classList.contains('hide')){ r.click(); }
        });
      }
      document.getElementById('collapseAll').onclick = ()=>{
        // Animate hide then remove nodes
        document.querySelectorAll('.ref-value').forEach(v=>{
          v.classList.remove('show'); v.classList.add('hide');
          setTimeout(()=>{ try{ v.remove() }catch(_){} }, 240);
        });
      }

      document.getElementById('copyBtn').onclick = ()=>{
        const text = document.getElementById('result').innerText;
        if(!text || text === 'Waiting for compression...'){
          alert('Nothing to copy yet! Compress a prompt first.');
          return;
        }
        navigator.clipboard.writeText(text).then(()=>{
          const old = document.getElementById('copyBtn').textContent;
          document.getElementById('copyBtn').textContent = '‚úì Copied!';
          setTimeout(()=> document.getElementById('copyBtn').textContent = old, 2000);
        }).catch(()=>{
          alert('Failed to copy. Please try again.');
        });
      }

      document.getElementById('resetTotal').onclick = ()=>{
        if(!confirm('Reset your cumulative token-saved counter? This is stored locally in your browser.')) return;
        writeTotal(0);
        setTotalDom(0);
      }

      // Initialize carbon meter on page load
      updateCarbonMeter(0);
    </script>
  </body>
</html>
